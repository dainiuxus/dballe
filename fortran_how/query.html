
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Querying the database &#8212; dballe 3.23 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Inserting data" href="insert.html" />
    <link rel="prev" title="Input/output records" href="iorecords.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="querying-the-database">
<h1>Querying the database<a class="headerlink" href="#querying-the-database" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
</div>
<div class="section" id="querying">
<span id="id1"></span><h2>Querying the database<a class="headerlink" href="#querying" title="Permalink to this headline">¶</a></h2>
<p>Queries are made by giving one or more extremes of space, time, level or time
range.  See <a class="reference internal" href="../general_ref/parms/query.html#parms-query"><span class="std std-ref">query_stations</span></a> for a list of all available query parameters.</p>
<div class="section" id="querying-the-station-values">
<h3>Querying the station values<a class="headerlink" href="#querying-the-station-values" title="Permalink to this headline">¶</a></h3>
<p>Example code to query all the stations in a given area:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_setd</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s2">&quot;latmin&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="mf">0.D0</span><span class="p">)</span>
<span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_setd</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s2">&quot;latmax&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="mf">0.D0</span><span class="p">)</span>
<span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_setd</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s2">&quot;lonmin&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="mf">0.D0</span><span class="p">)</span>
<span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_setd</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s2">&quot;lonmax&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="mf">0.D0</span><span class="p">)</span>
<span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_query_stations</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="nb">count</span><span class="p">)</span>
<span class="k">do while</span> <span class="p">(</span><span class="nb">count</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_next_station</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
  <span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_enqi</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s2">&quot;ana_id&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span>
  <span class="c">! Pseudoana values can be read as well:</span>
  <span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_enqc</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">cname</span><span class="p">)</span>
  <span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_enqd</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s2">&quot;B07001&quot;</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
  <span class="c">! ...query more data and work with it...</span>
  <span class="nb">count</span> <span class="o">=</span> <span class="nb">count</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">enddo</span>
</pre></div>
</div>
<p>This code introduces two new functions:</p>
<ul class="simple">
<li><a class="reference internal" href="../fortran_ref/functions.html#c.idba_query_stations" title="idba_query_stations"><code class="xref c c-func docutils literal notranslate"><span class="pre">idba_query_stations()</span></code></a>: performs the query and returns the number of stations it
finds.</li>
<li><a class="reference internal" href="../fortran_ref/functions.html#c.idba_next_station" title="idba_next_station"><code class="xref c c-func docutils literal notranslate"><span class="pre">idba_next_station()</span></code></a>: gets a station out of the results of <a class="reference internal" href="../fortran_ref/functions.html#c.idba_query_stations" title="idba_query_stations"><code class="xref c c-func docutils literal notranslate"><span class="pre">idba_query_stations()</span></code></a>.
If there are no more stations, the function fails.</li>
</ul>
<p>After <a class="reference internal" href="../fortran_ref/functions.html#c.idba_next_station" title="idba_next_station"><code class="xref c c-func docutils literal notranslate"><span class="pre">idba_next_station()</span></code></a>, the output record will also contain all the pseudoana
values available for the station.  If <cite>rep_cod</cite> or <cite>rep_memo</cite> are specified as
query parameters, the pseudoana values of that network will be used.  Else,
<a class="reference internal" href="../fortran_ref/functions.html#c.idba_next_station" title="idba_next_station"><code class="xref c c-func docutils literal notranslate"><span class="pre">idba_next_station()</span></code></a> will use all available pseudoana values, choosing the one in
the network with the highest priority in case the same pseudoana value is
available on more than one network.</p>
</div>
<div class="section" id="querying-the-measured-values">
<h3>Querying the measured values<a class="headerlink" href="#querying-the-measured-values" title="Permalink to this headline">¶</a></h3>
<p>Example code to query all the values in a given area and time:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_seti</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s2">&quot;latmin&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_seti</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s2">&quot;latmax&quot;</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_seti</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s2">&quot;lonmin&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_seti</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s2">&quot;lonmax&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_seti</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s2">&quot;yearmin&quot;</span><span class="p">,</span> <span class="mi">2004</span><span class="p">)</span>
<span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_seti</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s2">&quot;yearmax&quot;</span><span class="p">,</span> <span class="mi">2004</span><span class="p">)</span>
<span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_query_data</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="nb">count</span><span class="p">)</span>
<span class="k">do while</span> <span class="p">(</span><span class="nb">count</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_next_data</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
  <span class="c">! get the value of this variable</span>
  <span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_enqc</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">cvalue</span><span class="p">)</span>
  <span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_enqd</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="n">dlat</span><span class="p">)</span>
  <span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_enqd</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="n">dlon</span><span class="p">)</span>
  <span class="c">! query more data and work with it</span>
  <span class="nb">count</span> <span class="o">=</span> <span class="nb">count</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">enddo</span>
</pre></div>
</div>
<p>This code introduces two new functions:</p>
<ul class="simple">
<li><a class="reference internal" href="../fortran_ref/functions.html#c.idba_query_data" title="idba_query_data"><code class="xref c c-func docutils literal notranslate"><span class="pre">idba_query_data()</span></code></a>: performs the query and returns the number of values it
finds.</li>
<li><a class="reference internal" href="../fortran_ref/functions.html#c.idba_next_data" title="idba_next_data"><code class="xref c c-func docutils literal notranslate"><span class="pre">idba_next_data()</span></code></a>: gets a value out of the result of <a class="reference internal" href="../fortran_ref/functions.html#c.idba_query_data" title="idba_query_data"><code class="xref c c-func docutils literal notranslate"><span class="pre">idba_query_data()</span></code></a>.  If
there are no more stations, the function fails.</li>
</ul>
</div>
</div>
<div class="section" id="modifiers-for-queries">
<h2>Modifiers for queries<a class="headerlink" href="#modifiers-for-queries" title="Permalink to this headline">¶</a></h2>
<p>DB-All.e allows to set special query behaviours using the <code class="docutils literal notranslate"><span class="pre">&quot;query&quot;</span></code>
parameter.  The available options are:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">best</span></code>: When measures from different kinds of reports exist in the same
physical space, do not return them all, but only return the one of the record
type with the highest priority.</li>
</ul>
</div>
<div class="section" id="shortcuts-to-stations-and-data">
<h2>Shortcuts to stations and data<a class="headerlink" href="#shortcuts-to-stations-and-data" title="Permalink to this headline">¶</a></h2>
<p>DB-All.e offers two shortcuts to represent pseudoana entries and data in the
database: the <code class="docutils literal notranslate"><span class="pre">ana_id</span></code> and the <code class="docutils literal notranslate"><span class="pre">data_id</span></code> keys, that are set in the
output of every <a class="reference internal" href="../fortran_ref/functions.html#c.idba_next_data" title="idba_next_data"><code class="xref c c-func docutils literal notranslate"><span class="pre">idba_next_data()</span></code></a>.</p>
<p><code class="docutils literal notranslate"><span class="pre">ana_id</span></code> represents a pseudoana entry.  Every time one needs to specify a
set of latitude, longitude, fixed/mobile, one could use the corresponding
<code class="docutils literal notranslate"><span class="pre">ana_id</span></code> value, if known, and get a faster search.</p>
<p><code class="docutils literal notranslate"><span class="pre">data_id</span></code> represents a data entry.  Every time one needs to identify some
data setting latitude, longitude, level layer, time range and so on, one can
just provide the value of <code class="docutils literal notranslate"><span class="pre">data_id</span></code>, and also get a faster search.</p>
</div>
<div class="section" id="code-examples">
<h2>Code examples<a class="headerlink" href="#code-examples" title="Permalink to this headline">¶</a></h2>
<div class="section" id="query-data-then-query-station-data">
<h3>Query data, then query station data<a class="headerlink" href="#query-data-then-query-station-data" title="Permalink to this headline">¶</a></h3>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_begin</span><span class="p">(</span><span class="n">dbhandle</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="s2">&quot;read&quot;</span><span class="p">,</span> <span class="s2">&quot;read&quot;</span><span class="p">,</span> <span class="s2">&quot;read&quot;</span><span class="p">)</span>
<span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_begin</span><span class="p">(</span><span class="n">dbhandle</span><span class="p">,</span> <span class="n">handleana</span><span class="p">,</span> <span class="s2">&quot;read&quot;</span><span class="p">,</span> <span class="s2">&quot;read&quot;</span><span class="p">,</span> <span class="s2">&quot;read&quot;</span><span class="p">)</span>

<span class="c">! Prepare a query</span>
<span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_setd</span> <span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s2">&quot;latmin&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="p">...</span>
<span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_setd</span> <span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s2">&quot;lonmax&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>

<span class="c">! Make the query</span>
<span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_query_data</span> <span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

<span class="c">! Iterate the results</span>
<span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span>
  <span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_next_data</span> <span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">varname</span><span class="p">)</span>

  <span class="c">! Read data about the variable we just had</span>
  <span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_enqlevel</span> <span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">ltype</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">)</span>

  <span class="c">! Read pseudoana data about the variable we just had</span>
  <span class="c">! Setup a query for the station with &#39;query_stations&#39;</span>
  <span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_enqi</span> <span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s2">&quot;ana_id&quot;</span><span class="p">,</span> <span class="n">anaid</span><span class="p">)</span>
  <span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_seti</span> <span class="p">(</span><span class="n">handleana</span><span class="p">,</span> <span class="s2">&quot;ana_id&quot;</span><span class="p">,</span> <span class="n">anaid</span><span class="p">)</span>

  <span class="c">! Query.  Nstaz should always be 1 because we query a specific station</span>
  <span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_query_stations</span> <span class="p">(</span><span class="n">handleana</span><span class="p">,</span> <span class="n">Nstaz</span><span class="p">)</span>

  <span class="c">! Fetch the data</span>
  <span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_next_station</span> <span class="p">(</span><span class="n">handleana</span><span class="p">)</span>

  <span class="c">! Read the data about the station</span>
  <span class="c">! All the data inserted with set_station_context is available here</span>
  <span class="n">ierr</span> <span class="o">=</span> <span class="n">idba_enqi</span> <span class="p">(</span><span class="n">handleana</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
<span class="n">enddo</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">dballe</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../howtos.html">How-to guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../python_how/index.html">Python HOWTOs</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Fortran HOWTOs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference.html">Reference documentation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="../howtos.html">How-to guides</a><ul>
  <li><a href="index.html">Fortran HOWTOs</a><ul>
      <li>Previous: <a href="iorecords.html" title="previous chapter">Input/output records</a></li>
      <li>Next: <a href="insert.html" title="next chapter">Inserting data</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Enrico Zini.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/fortran_how/query.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>